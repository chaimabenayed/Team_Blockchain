.PHONY: help install compile test coverage gas deploy-local deploy-sepolia verify clean node analyze analyze-detailed

# Couleurs pour l'affichage
GREEN=\033[0;32m
YELLOW=\033[1;33m
RED=\033[0;31m
NC=\033[0m # No Color

help: ## Affiche cette aide
	@echo "$(GREEN)SafeClub - Commandes disponibles:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'

install: ## Installe toutes les d√©pendances
	@echo "$(GREEN)üì¶ Installation des d√©pendances...$(NC)"
	npm install
	@echo "$(GREEN)‚úÖ Installation termin√©e!$(NC)"

compile: ## Compile les smart contracts
	@echo "$(GREEN)‚öôÔ∏è  Compilation des contrats...$(NC)"
	npx hardhat compile
	@echo "$(GREEN)‚úÖ Compilation termin√©e!$(NC)"

clean: ## Nettoie les fichiers de build
	@echo "$(YELLOW)üßπ Nettoyage...$(NC)"
	npx hardhat clean
	rm -rf cache artifacts coverage coverage.json
	@echo "$(GREEN)‚úÖ Nettoyage termin√©!$(NC)"

test: ## Lance tous les tests
	@echo "$(GREEN)üß™ Lancement des tests...$(NC)"
	npx hardhat test

test-verbose: ## Lance les tests avec d√©tails
	@echo "$(GREEN)üß™ Tests d√©taill√©s...$(NC)"
	npx hardhat test --verbose

coverage: ## G√©n√®re le rapport de couverture
	@echo "$(GREEN)üìä G√©n√©ration de la couverture...$(NC)"
	npx hardhat coverage
	@echo "$(GREEN)üìÇ Ouvrir coverage/index.html pour voir le rapport$(NC)"

gas: ## G√©n√®re le rapport de gas
	@echo "$(GREEN)‚õΩ Analyse du gas...$(NC)"
	REPORT_GAS=true npx hardhat test
	@echo "$(GREEN)üìÇ Voir gas-report.txt$(NC)"

node: ## D√©marre un n≈ìud Hardhat local
	@echo "$(GREEN)üöÄ D√©marrage du n≈ìud local...$(NC)"
	npx hardhat node

deploy-local: ## D√©ploie sur le r√©seau local
	@echo "$(GREEN)üöÄ D√©ploiement local...$(NC)"
	npx hardhat run scripts/deploy.js --network localhost

deploy-sepolia: ## D√©ploie sur Sepolia testnet
	@echo "$(GREEN)üöÄ D√©ploiement sur Sepolia...$(NC)"
	npx hardhat run scripts/deploy.js --network sepolia

verify: ## V√©rifie le contrat sur Etherscan (ADDR=0x...)
	@echo "$(GREEN)üîç V√©rification sur Etherscan...$(NC)"
	@if [ -z "$(ADDR)" ]; then \
		echo "$(RED)‚ùå Erreur: Sp√©cifiez l'adresse avec ADDR=0x...$(NC)"; \
		exit 1; \
	fi
	npx hardhat verify --network sepolia $(ADDR)

analyze: ## Analyse de s√©curit√© avec Slither
	@echo "$(GREEN)üîç Analyse Slither...$(NC)"
	@if ! command -v slither &> /dev/null; then \
		echo "$(RED)‚ùå Slither non install√©!$(NC)"; \
		echo "$(YELLOW)Installez avec: pip3 install slither-analyzer$(NC)"; \
		exit 1; \
	fi
	mkdir -p reports
	slither . --checklist --markdown-root ./reports
	@echo "$(GREEN)‚úÖ Rapport g√©n√©r√© dans reports/$(NC)"

analyze-detailed: ## Analyse d√©taill√©e avec Slither
	@echo "$(GREEN)üîç Analyse d√©taill√©e...$(NC)"
	slither . --print human-summary,inheritance-graph,contract-summary

analyze-reentrancy: ## V√©rifie les r√©entrances
	@echo "$(GREEN)üîç V√©rification des r√©entrances...$(NC)"
	slither . --detect reentrancy-eth

console-local: ## Console Hardhat locale
	@echo "$(GREEN)üíª Console locale...$(NC)"
	npx hardhat console --network localhost

console-sepolia: ## Console Hardhat Sepolia
	@echo "$(GREEN)üíª Console Sepolia...$(NC)"
	npx hardhat console --network sepolia

serve: ## Lance un serveur web local
	@echo "$(GREEN)üåê Serveur web sur http://localhost:8000$(NC)"
	python3 -m http.server 8000

check-balance: ## V√©rifie le solde du d√©ployeur
	@echo "$(GREEN)üí∞ V√©rification du solde...$(NC)"
	@node -e "const hre = require('hardhat'); \
		(async () => { \
			const [deployer] = await hre.ethers.getSigners(); \
			const balance = await hre.ethers.provider.getBalance(deployer.address); \
			console.log('Adresse:', deployer.address); \
			console.log('Balance:', hre.ethers.formatEther(balance), 'ETH'); \
		})();"

setup: install ## Setup complet du projet
	@echo "$(GREEN)‚öôÔ∏è  Configuration initiale...$(NC)"
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "$(YELLOW)‚ö†Ô∏è  √âditez le fichier .env avec vos cl√©s$(NC)"; \
	fi
	@echo "$(GREEN)‚úÖ Setup termin√©!$(NC)"

all-tests: clean compile test coverage gas ## Lance tous les tests et rapports
	@echo "$(GREEN)‚úÖ Tous les tests termin√©s!$(NC)"

pre-deploy: clean compile test analyze ## V√©rifications avant d√©ploiement
	@echo "$(GREEN)‚úÖ Pr√™t pour le d√©ploiement!$(NC)"

deploy-and-verify: deploy-sepolia ## D√©ploie et v√©rifie (ADDR sera auto-d√©tect√©)
	@echo "$(YELLOW)‚è≥ Attente de 30 secondes pour la propagation...$(NC)"
	sleep 30
	@echo "$(GREEN)üîç V√©rification du contrat...$(NC)"
	@ADDR=$$(cat deployments/sepolia.json | grep -o '"contractAddress":"[^"]*"' | cut -d'"' -f4); \
	npx hardhat verify --network sepolia $$ADDR

full-check: ## Check complet (tests + s√©curit√© + gas)
	@echo "$(GREEN)üîç V√©rification compl√®te...$(NC)"
	@make clean
	@make compile
	@make test
	@make coverage
	@make gas
	@make analyze
	@echo "$(GREEN)‚úÖ V√©rification compl√®te termin√©e!$(NC)"
